---
- hosts: all
  become: true
  roles:
    - role: "avinetworks.docker"

- hosts: all
  tasks:
    - name: "Enable port to expose deamon REST API"
      firewalld:
        zone: public
        port: "2375/tcp"
        permanent: true
        state: enabled
      become: true
    - name: "Reload firewalld"
      command: firewall-cmd --reload
      changed_when: false
      become: true
    - name: "Replace line"
      lineinfile: 
        path: /lib/systemd/system/docker.service
        regexp: '^(.*)ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock(.*)$' 
        line: 'ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock  -H=tcp://0.0.0.0:2375'
        backrefs: true
    - name: "Reload deamon"
      command: "systemd daemon-reload"
      changed_when: false
    - name: "Reload docker service"
      command: "sudo service docker restart"
      changed_when: false

- hosts: all
  become: true
  tasks:
    - name: "Enable ports for docker swarm"
      firewalld:
        zone: public
        port: "{{ item }}"
        permanent: true
        state: enabled
      become: true
      with_items:
        - 2377/tcp
        - 7946/tcp
        - 7946/udp
        - 4789/udp
    - name: "Reload firewalld"
      command: firewall-cmd --reload
      become: true
      changed_when: false
- hosts: all
  become: true
  roles:
    - role: "atosatto.docker-swarm"
      docker_swarm_interface: "eth1"
